version: 2.1

executors:
  py:
    docker:
      - image: cimg/python:3.12
  dind:
    docker:
      - image: cimg/base:stable

jobs:
  test:
    executor: py
    steps:
      - checkout
      - run:
          name: Install deps & pytest
          command: |
            cd pmulaniapi
            python -m pip install --upgrade pip
            pip install -r requirements.txt pytest
            pip install httpx
            pytest -q
  build_and_push:
    executor: dind
    environment:
      IMAGE_TAG: << pipeline.git.revision >>
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install awscli & buildx
          command: |
            sudo apt-get update && sudo apt-get install -y jq curl unzip
            curl -Ls "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip
            unzip -q /tmp/awscliv2.zip -d /tmp && sudo /tmp/aws/install
            mkdir -p ~/.docker/cli-plugins
            curl -sSL https://github.com/docker/buildx/releases/download/v0.14.0/buildx-v0.14.0.linux-amd64 \
              -o ~/.docker/cli-plugins/docker-buildx && chmod +x ~/.docker/cli-plugins/docker-buildx
      - &preflight_assume_role
        run:
          name: Assume deploy role (if set)
          command: |
            set -euo pipefail
            # Region fallback + persist for later steps
            export AWS_REGION="${AWS_REGION:-${REGION:-eu-west-1}}"
            export AWS_DEFAULT_REGION="$AWS_REGION"
            echo "export AWS_REGION=$AWS_REGION" >> "$BASH_ENV"
            echo "export AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION" >> "$BASH_ENV"
            
            # Require base creds if you plan to assume a role
            if [ -n "${DEPLOY_ROLE_ARN:-}" ]; then
              if [ -z "${AWS_ACCESS_KEY_ID:-}" ] || [ -z "${AWS_SECRET_ACCESS_KEY:-}" ]; then
                echo "ERROR: DEPLOY_ROLE_ARN is set but base AWS credentials are missing."
                exit 1
              fi
              echo "Assuming role: $DEPLOY_ROLE_ARN"
              CREDS="$(aws sts assume-role \
                --role-arn "$DEPLOY_ROLE_ARN" \
                --role-session-name "circleci-${CIRCLE_WORKFLOW_ID}" \
                --duration-seconds 3600)"
              # Persist creds for next steps
              echo "export AWS_ACCESS_KEY_ID=$(echo "$CREDS" | jq -r .Credentials.AccessKeyId)" >> "$BASH_ENV"
              echo "export AWS_SECRET_ACCESS_KEY=$(echo "$CREDS" | jq -r .Credentials.SecretAccessKey)" >> "$BASH_ENV"
              echo "export AWS_SESSION_TOKEN=$(echo "$CREDS" | jq -r .Credentials.SessionToken)" >> "$BASH_ENV"
            else
              echo "DEPLOY_ROLE_ARN not set; using provided base credentials."
            fi
      - run: aws sts get-caller-identity
      - run:
          name: Login to ECR
          command: |
            set -euo pipefail
            REPO_URL="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
            # Create the repo if it doesn't exist (requires CreateRepository on the role)
            aws ecr describe-repositories --repository-names "$ECR_REPO_NAME" \
              --region "$AWS_REGION" >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name "$ECR_REPO_NAME" \
              --region "$AWS_REGION" >/dev/null
            aws ecr get-login-password --region "$AWS_REGION" \
              | docker login --username AWS --password-stdin \
                "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
            echo "export REPO_URL=$REPO_URL" >> "$BASH_ENV"
      - run:
          name: Build & push image (linux/amd64)
          command: |
            source $BASH_ENV
            docker buildx create --use --name cross 2>/dev/null || docker buildx use cross
            # NOTE: build context changed from 'app' to 'pmulaniapi'
            docker buildx build --platform linux/amd64 \
              -t "$REPO_URL:${IMAGE_TAG}" -t "$REPO_URL:latest" \
              pmulaniapi --push

  deploy_eks:
    executor: dind
    environment:
      IMAGE_TAG: << pipeline.git.revision >>
    steps:
      - checkout
      - run:
          name: Install kubectl, helm, awscli
          command: |
            set -euo pipefail
            
            #kubectl
            curl -LO "https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            sudo install -m 0755 kubectl /usr/local/bin/kubectl
            
            # helm
            curl -sSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
            helm plugin install https://github.com/jkroepke/helm-secrets
            
            # aws-cli
            curl -Ls "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip
            unzip -q /tmp/awscliv2.zip -d /tmp && sudo /tmp/aws/install
            sudo apt-get update && sudo apt-get install -y jq
      - *preflight_assume_role
      - run:
          name: Who am I?
          command: aws sts get-caller-identity --query Arn --output text
      - run:
          name: Auth to EKS
          command: |
            aws eks describe-cluster --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION"
            aws eks update-kubeconfig --name "$EKS_CLUSTER_NAME" --region "$AWS_REGION"
            kubectl get ns
      - run:
          name: Helm upgrade
          command: |
            REPO_URL="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO_NAME}"
            helm upgrade --install "$HELM_RELEASE" ./charts \
              -n "$K8S_NAMESPACE" --create-namespace \
              -f charts/values.yaml \
              -f charts/values-secrets-ci.yaml \
              --set image.repository="$REPO_URL" \
              --set image.tag="$IMAGE_TAG" \
              --wait --atomic
      - run:
          name: Wait for rollout
          command: |
            kubectl -n "$K8S_NAMESPACE" rollout status deploy/"$HELM_RELEASE" --timeout=5m

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - test
      - build_and_push:
          filters:
            branches:
              only: [main]
      - deploy_eks:
          requires: [build_and_push]
          filters:
            branches:
              only: [main]
